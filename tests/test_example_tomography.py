""" Tests our inversion toolbox on a simple tomography case
presented in Tarantola 7.3.
"""
import numpy as np
import volcapy.inversion as inv
from numpy.testing import assert_allclose


m_prior = np.array([55, 55, 55, 55, 55, 55, 55, 55, 55])
cov_m = np.diag([15**2]*9)

G = np.array([
        [0.3338, 1.6971, 0.0000, 2.0309, 0.0000, 0.0000, 2.0309, 0.0000, 0.0000],
        [0.0000, 2.0110, 0.0000, 0.0000, 2.0110, 0.0000, 0.4883, 1.5227, 0.0000],
        [0.0000, 2.0012, 0.0000, 0.0000, 2.0012, 0.0000, 0.0000, 2.0012, 0.0000],
        [0.0000, 2.0012, 0.0000, 0.0000, 2.0012, 0.0000, 0.0000, 2.0012, 0.0000],
        [0.0000, 2.0110, 0.0000, 0.0000, 2.0110, 0.0000, 0.0000, 1.5227, 0.4883],
        [0.0000, 1.6971, 0.3338, 0.0000, 0.0000, 2.0309, 0.0000, 0.0000, 2.0309],
        [0.0000, 0.0000, 0.0000, 1.6971, 0.0000, 0.0000, 0.3338, 2.0309, 2.0309],
        [0.0000, 0.0000, 0.0000, 2.0110, 2.0110, 1.5227, 0.0000, 0.0000, 0.4883],
        [0.0000, 0.0000, 0.0000, 2.0012, 2.0012, 2.0012, 0.0000, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.0000, 2.0012, 2.0012, 2.0012, 0.0000, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.4883, 2.0110, 2.0110, 1.5227, 0.0000, 0.0000, 0.0000],
        [0.3338, 2.0309, 2.0309, 1.6971, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
        ])

d_obs = np.array(
        [341.9, 353.1, 356.2, 356.2, 353.1, 341.9, 341.9, 353.1, 356.2, 356.2,
                353.1, 341.9])
cov_d = np.diag([0.1**2]*12)

m_res_model = inv.inversion_model(m_prior, cov_m, d_obs, cov_d, G)
m_res_data = inv.inversion_data(m_prior, cov_m, d_obs, cov_d, G)

theoretical_result = np.array(
        [55.89387092, 59.30263641, 50.30397254, 59.30263641, 58.4675599,
               60.22285215, 50.30397254, 60.22285215, 50.30257655])

assert_allclose(m_res_model, theoretical_result, atol=0.0001)
assert_allclose(m_res_data, theoretical_result, atol=0.0001)
